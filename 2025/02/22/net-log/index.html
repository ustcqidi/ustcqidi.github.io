<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"ustcqidi.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.22.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="思考当前客户端日志存在的问题，并深入学习 Chromium NetLog 的设计与实现细节，从中汲取灵感，打造一套适用于我们客户端产品的结构化事件日志系统。">
<meta property="og:type" content="article">
<meta property="og:title" content="Chromium NetLog 学习与客户端结构化日志的思考">
<meta property="og:url" content="https://ustcqidi.github.io/2025/02/22/net-log/">
<meta property="og:site_name" content="祁迪的博客">
<meta property="og:description" content="思考当前客户端日志存在的问题，并深入学习 Chromium NetLog 的设计与实现细节，从中汲取灵感，打造一套适用于我们客户端产品的结构化事件日志系统。">
<meta property="og:locale">
<meta property="og:image" content="https://ustcqidi.github.io/2025/02/22/net-log/net-log.png">
<meta property="og:image" content="https://ustcqidi.github.io/2025/02/22/net-log/net-viewer.jpg">
<meta property="article:published_time" content="2025-02-22T08:09:43.000Z">
<meta property="article:modified_time" content="2025-02-22T08:38:23.375Z">
<meta property="article:author" content="祁迪">
<meta property="article:tag" content="Chromium">
<meta property="article:tag" content="Troubleshooting">
<meta property="article:tag" content="关联分析">
<meta property="article:tag" content="自动化分析">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ustcqidi.github.io/2025/02/22/net-log/net-log.png">


<link rel="canonical" href="https://ustcqidi.github.io/2025/02/22/net-log/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-Hans","comments":true,"permalink":"https://ustcqidi.github.io/2025/02/22/net-log/","path":"2025/02/22/net-log/","title":"Chromium NetLog 学习与客户端结构化日志的思考"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Chromium NetLog 学习与客户端结构化日志的思考 | 祁迪的博客</title>
  

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?b4fa680bcca71536a4ad2a1ce53cf441"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="祁迪的博客" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">祁迪的博客</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">企业级客户端技术探索：架构设计·性能优化·效能提升</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E8%83%8C%E6%99%AF%E4%B8%8E%E7%8E%B0%E7%8A%B6"><span class="nav-number">1.</span> <span class="nav-text">一、背景与现状</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E9%97%AE%E9%A2%98%E4%B8%8E%E7%97%9B%E7%82%B9"><span class="nav-number">2.</span> <span class="nav-text">二、问题与痛点</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%97%A5%E5%BF%97%E6%A0%BC%E5%BC%8F%E4%B8%8D%E7%BB%9F%E4%B8%80"><span class="nav-number">2.1.</span> <span class="nav-text">1. 日志格式不统一</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%85%A8%E5%B1%80%E7%8A%B6%E6%80%81%E4%BF%A1%E6%81%AF%E4%B8%A2%E5%A4%B1"><span class="nav-number">2.2.</span> <span class="nav-text">2. 全局状态信息丢失</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%88%86%E6%95%A3%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%8D%E6%9D%82%E6%97%B6%E5%BA%8F"><span class="nav-number">2.3.</span> <span class="nav-text">3. 分散日志与复杂时序</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E8%87%AA%E5%8A%A8%E5%8C%96%E8%A7%A3%E6%9E%90%E9%9A%BE%E5%BA%A6%E5%A4%A7"><span class="nav-number">2.4.</span> <span class="nav-text">4. 自动化解析难度大</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%E6%96%B9%E5%BC%8F%E4%B8%8D%E7%90%86%E6%83%B3"><span class="nav-number">2.5.</span> <span class="nav-text">5. 日志存储方式不理想</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81Chromium-NetLog"><span class="nav-number">3.</span> <span class="nav-text">三、Chromium NetLog</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E7%9B%AE%E7%9A%84%E4%B8%8E%E8%8C%83%E5%9B%B4"><span class="nav-number">3.0.1.</span> <span class="nav-text">1. 目的与范围</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86%E4%B8%8E%E4%BA%8B%E4%BB%B6%E8%AE%B0%E5%BD%95"><span class="nav-number">3.0.2.</span> <span class="nav-text">2. 数据采集与事件记录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%A8%A1%E5%9D%97%E5%8C%96%E4%B8%8E%E5%88%86%E5%B1%82%E8%AE%BE%E8%AE%A1"><span class="nav-number">3.0.3.</span> <span class="nav-text">3. 模块化与分层设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F%E4%B8%8E%E5%AF%BC%E5%87%BA"><span class="nav-number">3.0.4.</span> <span class="nav-text">4. 数据格式与导出</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E6%80%A7%E8%83%BD%E8%80%83%E9%87%8F"><span class="nav-number">3.0.5.</span> <span class="nav-text">5. 性能考量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E8%B0%83%E8%AF%95%E4%B8%8E-Troubleshooting"><span class="nav-number">3.0.6.</span> <span class="nav-text">6. 调试与 Troubleshooting</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-%E5%AE%89%E5%85%A8%E4%B8%8E%E9%9A%90%E7%A7%81"><span class="nav-number">3.0.7.</span> <span class="nav-text">7. 安全与隐私</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E5%A4%9A%E5%B1%82%E6%AC%A1%E3%80%81%E7%BB%93%E6%9E%84%E5%8C%96%E6%97%A5%E5%BF%97%E7%9A%84%E6%80%9D%E8%80%83"><span class="nav-number">4.</span> <span class="nav-text">四、多层次、结构化日志的思考</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">4.1.</span> <span class="nav-text">1. 应用场景</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C"><span class="nav-number">4.1.1.</span> <span class="nav-text">数据库操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B%EF%BC%9A%E7%99%BB%E5%BD%95%E4%B8%8E%E5%8A%A0%E4%BC%9A"><span class="nav-number">4.1.2.</span> <span class="nav-text">核心业务流程：登录与加会</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E9%9C%80%E8%A6%81%E8%A7%A3%E5%86%B3%E7%9A%84%E5%85%B3%E9%94%AE%E9%97%AE%E9%A2%98"><span class="nav-number">4.2.</span> <span class="nav-text">2. 需要解决的关键问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Debug-Log-%E7%9A%84%E4%BF%9D%E7%95%99%E4%B8%8E%E6%B7%98%E6%B1%B0"><span class="nav-number">4.2.1.</span> <span class="nav-text">Debug Log 的保留与淘汰</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E7%94%A8%E4%B8%94%E5%8F%AF%E6%89%A9%E5%B1%95%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B8%8E%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1"><span class="nav-number">4.2.2.</span> <span class="nav-text">通用且可扩展的数据类型与接口设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8E%E7%8E%B0%E6%9C%89%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%95%B4%E5%90%88"><span class="nav-number">4.2.3.</span> <span class="nav-text">与现有日志系统的整合</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E6%97%A5%E5%BF%97%E7%B1%BB%E5%9E%8B%E5%8F%8A-Troubleshooting-%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">4.3.</span> <span class="nav-text">3. 日志类型及 Troubleshooting 应用场景</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Log-%E7%B1%BB%E5%9E%8B"><span class="nav-number">4.3.1.</span> <span class="nav-text">Log 类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Troubleshooting-%E5%9C%BA%E6%99%AF"><span class="nav-number">4.3.2.</span> <span class="nav-text">Troubleshooting 场景</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E5%85%B7%E4%BD%93%E5%AE%9E%E4%BE%8B%E4%B8%8E-NetLog-%E5%80%9F%E9%89%B4"><span class="nav-number">4.4.</span> <span class="nav-text">4. 具体实例与 NetLog 借鉴</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E9%80%9A%E7%94%A8%E7%BB%93%E6%9E%84%E5%8C%96%E4%BA%8B%E4%BB%B6%E6%97%A5%E5%BF%97%E6%A8%A1%E5%9D%97-EventLogger"><span class="nav-number">5.</span> <span class="nav-text">五、通用结构化事件日志模块 : EventLogger</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E4%BA%8B%E4%BB%B6%E7%B1%BB%E5%9E%8B"><span class="nav-number">5.1.</span> <span class="nav-text">1. 事件类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">5.2.</span> <span class="nav-text">2. 数据结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E7%94%A8-HTTPRequestEntity-%E7%AE%A1%E7%90%86-Source"><span class="nav-number">5.3.</span> <span class="nav-text">3. 用 HTTPRequestEntity 管理 Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E5%B0%86-libCURL-%E6%97%A5%E5%BF%97%E8%BD%AC%E6%8D%A2%E4%B8%BA%E7%BB%93%E6%9E%84%E5%8C%96%E4%BA%8B%E4%BB%B6%E6%97%A5%E5%BF%97"><span class="nav-number">5.4.</span> <span class="nav-text">4. 将 libCURL 日志转换为结构化事件日志</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E7%BB%93%E6%9E%84%E5%8C%96%E7%9A%84%E7%BD%91%E7%BB%9C%E4%BA%8B%E4%BB%B6-Log-%E7%A4%BA%E4%BE%8B"><span class="nav-number">5.5.</span> <span class="nav-text">5. 结构化的网络事件 Log 示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">5.6.</span> <span class="nav-text">6. 应用场景</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E6%80%BB%E7%BB%93"><span class="nav-number">6.</span> <span class="nav-text">六、总结</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">祁迪</p>
  <div class="site-description" itemprop="description">专注企业级客户端应用基础架构设计与性能优化，分享网络通信、数据库、APM等底层技术实践。记录 Troubleshooting、工程效能提升等实战经验，探讨大型应用开发的技术创新。</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">50</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">86</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/ustcqidi" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ustcqidi" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://ustcqidi.github.io/2025/02/22/net-log/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="祁迪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="祁迪的博客">
      <meta itemprop="description" content="专注企业级客户端应用基础架构设计与性能优化，分享网络通信、数据库、APM等底层技术实践。记录 Troubleshooting、工程效能提升等实战经验，探讨大型应用开发的技术创新。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Chromium NetLog 学习与客户端结构化日志的思考 | 祁迪的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Chromium NetLog 学习与客户端结构化日志的思考
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-02-22 16:09:43 / Modified: 16:38:23" itemprop="dateCreated datePublished" datetime="2025-02-22T16:09:43+08:00">2025-02-22</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>思考当前客户端日志存在的问题，并深入学习 Chromium NetLog 的设计与实现细节，从中汲取灵感，打造一套适用于我们客户端产品的结构化事件日志系统。</p>
<span id="more"></span>
<h1 id="一、背景与现状"><a href="#一、背景与现状" class="headerlink" title="一、背景与现状"></a>一、背景与现状</h1><p>日志为 <code>Troubleshooting</code> 提供了关键信息，记录了 App 运行期间的各项上下文数据。理想的日志能够反映 App 运行时的所有状态信息，凭借这些数据，我们可以自信地定位和解决各种问题。</p>
<p>专业的诊断工具展示了理想日志的标准：Wireshark 能捕获并记录网络请求的每一个细节；而 Linux 与 Windows 的内存转储（Dump）文件则保存了进程运行期间的内存布局、寄存器状态等底层数据。凭借这些详尽的信息，我们可以精确还原应用程序在特定时刻的运行状态。</p>
<p>然而，实际情况往往并非如此。我们平时常遇到客户反馈问题时，最终提供的信息不足，迫使开发者不得不新增日志后，再要求客户复现问题以采集日志数据。</p>
<h1 id="二、问题与痛点"><a href="#二、问题与痛点" class="headerlink" title="二、问题与痛点"></a>二、问题与痛点</h1><h2 id="1-日志格式不统一"><a href="#1-日志格式不统一" class="headerlink" title="1. 日志格式不统一"></a>1. 日志格式不统一</h2><ul>
<li>每个开发者都有自己的日志书写习惯——关键字、日志信息密度、时序记录等各不相同，导致日志分散且格式参差不齐。</li>
<li>在 Troubleshooting 时，查找所有关键日志项、理清时序及关联关系变得十分困难。</li>
<li>例如，分析某个请求的代理解析状态时，需要先搜索代理配置相关日志，再查看解析过程中的异常信息。若对 Proxy 解析流程不熟悉，问题排查便异常艰巨。</li>
</ul>
<h2 id="2-全局状态信息丢失"><a href="#2-全局状态信息丢失" class="headerlink" title="2. 全局状态信息丢失"></a>2. 全局状态信息丢失</h2><ul>
<li>某些问题仅靠现有日志难以还原现场。</li>
<li>例如，我们将每个网络请求封装成一个 Request 对象，并配备对应的 Handler 用于处理响应。</li>
<li>业务方提前卸载或删除 Handler 导致的野指针 Crash，仅依靠堆栈信息难以确定具体是哪一个 Handler 出现了问题。</li>
<li>因此，在 Crash 时若能 dump 当前网络模块正在处理的所有请求状态，就能大大简化问题定位。</li>
</ul>
<h2 id="3-分散日志与复杂时序"><a href="#3-分散日志与复杂时序" class="headerlink" title="3. 分散日志与复杂时序"></a>3. 分散日志与复杂时序</h2><ul>
<li>例如，App 使用 WebSocket 实现 Push Notification 时，经常有用户反馈未能及时收到关键数据包。</li>
<li>单靠记录 WebSocket 关键时间点的日志，这些记录可能被淹没在海量日志中，难以构成完整的连接状态变迁。</li>
<li>如果能维护一个全局的 WebSocket 连接状态上下文，在关键时刻 dump 出完整信息，就能快速排查此类问题。</li>
</ul>
<h2 id="4-自动化解析难度大"><a href="#4-自动化解析难度大" class="headerlink" title="4. 自动化解析难度大"></a>4. 自动化解析难度大</h2><ul>
<li>现阶段，仅依赖正则表达式对日志进行机械搜索，往往无法捕获需要跨多条日志关键字比对和关联的时序信息。</li>
<li>这使得利用大模型或 AI 进行日志自动化分析变得极其困难。</li>
</ul>
<h2 id="5-日志存储方式不理想"><a href="#5-日志存储方式不理想" class="headerlink" title="5. 日志存储方式不理想"></a>5. 日志存储方式不理想</h2><ul>
<li>当前所有模块的日志都写入一个“<strong>大而全</strong>”的日志文件中。</li>
<li>为了提取出与特定模块相关的日志，我们只能打开多个过滤结果的小窗口，手动对比时序和特征。</li>
<li>缺乏统一的关键字过滤机制，使得 Troubleshooting 工作变得繁琐低效。</li>
</ul>
<h1 id="三、Chromium-NetLog"><a href="#三、Chromium-NetLog" class="headerlink" title="三、Chromium NetLog"></a>三、Chromium NetLog</h1><p>Chromium 的 NetLog 提供了很好的参考。NetLog 是一个专门用于记录网络堆栈行为和事件的内置日志系统，其设计思路值得借鉴。</p>
<h3 id="1-目的与范围"><a href="#1-目的与范围" class="headerlink" title="1. 目的与范围"></a>1. 目的与范围</h3><p>NetLog 记录了网络库（如 URLRequest、Socket 连接、HTTP/2 流、TLS 握手以及代理解析等）中的关键事件和状态变化，为调试和性能分析提供详尽的数据支持。</p>
<h3 id="2-数据采集与事件记录"><a href="#2-数据采集与事件记录" class="headerlink" title="2. 数据采集与事件记录"></a>2. 数据采集与事件记录</h3><p>NetLog 通过在各个网络模块内部嵌入日志点（logging points）来捕获网络活动。每个日志事件通常包含以下几个部分：</p>
<ul>
<li><strong>时间戳</strong>：标识事件发生的精确时刻</li>
<li><strong>事件类型</strong>：例如连接建立、请求开始、响应接收、TLS 握手失败等</li>
<li><strong>附加参数</strong>：详细描述事件的上下文，比如请求 URL、HTTP 状态码、错误码、延时统计、网络配置参数以及代理信息等</li>
<li><strong>对象关联</strong>：许多事件都会与特定的对象 ID 关联（如一个请求或连接），使得后续分析时能重建整个请求的生命周期</li>
</ul>
<p>这种设计允许 NetLog 支持基于时序的调试，例如将 DNS 解析、TCP 握手、TLS 握手、请求发送和响应接收等事件串联起来，呈现完整的请求轨迹。</p>
<h3 id="3-模块化与分层设计"><a href="#3-模块化与分层设计" class="headerlink" title="3. 模块化与分层设计"></a>3. 模块化与分层设计</h3><p>Chromium 的网络栈设计为多个独立模块，NetLog 则以模块化的方式进行记录。每个模块（例如 Socket、HTTP、代理解析等）都负责产生日志信息，而 NetLog 系统提供统一的接口聚合、格式化和导出这些信息。这种分层设计带来的好处包括：</p>
<ul>
<li><strong>灵活性</strong>：可以对不同模块进行单独调试或关闭日志采集，降低性能开销</li>
<li><strong>扩展性</strong>：新的网络功能模块可以方便地集成日志记录功能，而不必修改 NetLog 的核心代码</li>
</ul>
<h3 id="4-数据格式与导出"><a href="#4-数据格式与导出" class="headerlink" title="4. 数据格式与导出"></a>4. 数据格式与导出</h3><p>NetLog 生成的日志采用结构化数据格式（通常为 JSON），便于后续通过工具进行过滤、搜索和可视化。Chrome 内置了一个 NetLog Viewer，可以将这些 JSON 日志解析成图形化的时序视图，帮助用户直观地看到请求的各个阶段和各模块之间的交互。这样的设计支持：</p>
<ul>
<li><strong>跨平台调试</strong>：JSON 格式简单而标准，方便在各种平台上进行数据交换与分析</li>
<li><strong>自动化分析</strong>：借助结构化数据，可以利用脚本或大数据分析工具对大规模日志进行聚合、统计和性能瓶颈分析</li>
</ul>
<p>导出的日志文件默认名称是 <code>chrome-net-export-log.json</code> , 这个 json 文件主要包含三个结构 <code>constants</code>, <code>events</code>, <code>pooledData</code></p>
<p><img src="/2025/02/22/net-log/net-log.png" alt="image.png"></p>
<p>其中 <code>constants</code> 是常量定义，包含了 NetLog 系统中使用的各种枚举类型和错误码：</p>
<ol>
<li><strong>activeFieldTrialGroups</strong>:<ul>
<li>记录了当前启用的实验特性和配置组</li>
<li>例如 “ALPSNewCodepoint:EnabledLaunch”、”AdsP4:Default” 等</li>
<li>这些实验特性用于 A/B 测试和功能渐进式发布</li>
</ul>
</li>
<li><p><strong>事件类型(logEventTypes)</strong>:</p>
<ul>
<li>定义了所有可以记录的网络事件类型</li>
<li>包括：<ul>
<li>HTTP/HTTPS 相关事件</li>
<li>WebSocket 事件</li>
<li>DNS 解析事件</li>
<li>SSL/TLS 事件</li>
<li>Cache 操作事件</li>
<li>Proxy 相关事件</li>
<li>QUIC 协议事件</li>
</ul>
</li>
<li><p>以 WebSocket 为例：</p>
  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;WEBSOCKET_HANDSHAKE_MESSAGE_SENT&quot;</span>: <span class="number">73</span>,</span><br><span class="line">    <span class="string">&quot;WEBSOCKET_READ_BUFFER_SIZE_CHANGED&quot;</span>: <span class="number">574</span>,</span><br><span class="line">    <span class="string">&quot;WEBSOCKET_RECV_FRAME_HEADER&quot;</span>: <span class="number">575</span>,</span><br><span class="line">    <span class="string">&quot;WEBSOCKET_SENT_FRAME_HEADER&quot;</span>: <span class="number">576</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>WebSocket 连接状态追踪</li>
<li>数据帧收发记录</li>
<li>缓冲区管理监控</li>
</ul>
</li>
</ul>
</li>
<li><strong>logSourceType（日志来源类型）</strong><ul>
<li>标识日志生成模块，如：<ul>
<li><code>HTTP2_SESSION(10)</code>：HTTP/2会话日志</li>
<li><code>QUIC_SESSION(12)</code>：QUIC协议会话日志</li>
<li><code>CERT_VERIFIER_JOB(25)</code>：证书验证任务日志</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>事件阶段（logEventPhase）</strong></p>
<p> NetLog 使用三种基本的事件阶段来追踪操作的生命周期：</p>
 <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">logEventPhase: &#123;</span><br><span class="line">    <span class="string">&quot;PHASE_NONE&quot;</span>: <span class="number">0</span>,<span class="comment">// 独立事件</span></span><br><span class="line">    <span class="string">&quot;PHASE_BEGIN&quot;</span>: <span class="number">1</span>,<span class="comment">// 开始事件</span></span><br><span class="line">    <span class="string">&quot;PHASE_END&quot;</span>: <span class="number">2</span><span class="comment">// 结束事件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>应用场景</strong><ul>
<li>独立事件 (PHASE_NONE)<ul>
<li>用于记录瞬时状态变化</li>
<li>例如：配置更新、错误发生</li>
<li>不需要配对的单一事件</li>
</ul>
</li>
<li>开始事件 (PHASE_BEGIN)<ul>
<li>标记一个操作或状态的开始</li>
<li>必须有对应的结束事件</li>
<li>用于跟踪持续性操作</li>
</ul>
</li>
<li>结束事件 (PHASE_END)<ul>
<li>对应开始事件的结束标记</li>
<li>记录操作的完成状态</li>
<li>可以包含操作结果信息</li>
</ul>
</li>
</ul>
</li>
<li><strong>事件配对</strong><ul>
<li>生命周期追踪<ul>
<li>BEGIN/END 配对可以准确计算操作耗时</li>
<li>有助于发现未完成的操作</li>
<li>便于分析性能瓶颈</li>
</ul>
</li>
<li>状态一致性<ul>
<li>确保状态转换的完整性</li>
<li>帮助发现状态机错误</li>
<li>支持异步操作的追踪</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><strong>错误码(netError)</strong>:<ul>
<li>定义了网络栈中所有可能的错误类型，例如：<ul>
<li><code>ERR_CERT_AUTHORITY_INVALID(-202)</code>：证书颁发机构无效</li>
<li><code>ERR_QUIC_HANDSHAKE_FAILED(-358)</code>：QUIC握手失败</li>
<li><code>ERR_SSL_VERSION_OR_CIPHER_MISMATCH(-113)</code>：SSL版本或密码套件不匹配</li>
</ul>
</li>
<li>按照不同模块分类：<ul>
<li>常规网络错误(如连接超时、DNS失败)</li>
<li>SSL/证书错误</li>
<li>HTTP错误</li>
<li>Cache错误</li>
<li>Proxy错误</li>
<li>QUIC协议错误</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="5-性能考量"><a href="#5-性能考量" class="headerlink" title="5. 性能考量"></a>5. 性能考量</h3><p>日志系统在设计时需平衡详细信息采集和性能开销。NetLog 的设计提供了动态启用/禁用日志记录的机制，只有在开启详细调试时才会记录大量事件，平时保持较低的性能消耗。此外，日志采集的粒度和记录策略是可配置的，开发者可以根据实际需要选择采样率、日志级别（例如 DEBUG、INFO、ERROR）等参数，以减少对生产环境的影响。</p>
<h3 id="6-调试与-Troubleshooting"><a href="#6-调试与-Troubleshooting" class="headerlink" title="6. 调试与 Troubleshooting"></a>6. 调试与 Troubleshooting</h3><p>NetLog 的丰富数据帮助开发者在面对疑难网络问题时进行”<strong>时间旅行式</strong>“的调试。例如：</p>
<ul>
<li><strong>事件关联</strong>：通过关联不同事件（如请求开始与结束），可以重建出请求的完整生命周期，识别异常延时和错误点</li>
<li><strong>细粒度诊断</strong>：记录下每个阶段的详细参数（如 DNS 解析时间、TCP 连接时间、TLS 握手详情）使得开发者能快速定位瓶颈或错误原因</li>
</ul>
<p><img src="/2025/02/22/net-log/net-viewer.jpg" alt="image.png"></p>
<h3 id="7-安全与隐私"><a href="#7-安全与隐私" class="headerlink" title="7. 安全与隐私"></a>7. 安全与隐私</h3><p>由于 NetLog 记录了大量敏感网络交互信息，其设计中也包含了对数据的脱敏处理。某些敏感字段（如认证令牌、用户隐私信息等）会在日志中进行屏蔽或模糊化处理，以确保在调试时不会暴露过多用户数据。</p>
<h1 id="四、多层次、结构化日志的思考"><a href="#四、多层次、结构化日志的思考" class="headerlink" title="四、多层次、结构化日志的思考"></a>四、多层次、结构化日志的思考</h1><p>Zoom 客户端现有的日志大多是在开发阶段由开发者手动添加的文本日志，但日志的形式完全可以多样化。日志的主要目的是记录应用程序的运行状态，以便后续能够还原当时的场景。</p>
<p>日志既可以采用纯文本格式，也可以采用二进制格式，甚至可以在关键事件发生时自动触发日志记录，比如 Crash、关键业务流程失败或用户主动触发的问题反馈时。</p>
<p>成熟的系统通常采用多样化、多级别的日志记录策略。根据不同的触发条件，日志记录会侧重于不同类型的信息，例如：</p>
<ul>
<li>Android 系统在发生 ANR（应用无响应）时，会生成专门的 ANR 日志，详细记录线程状态和资源占用；</li>
<li>Crash 时会产生 Tombstone 文件，保存崩溃时的完整调用栈和内存状态；</li>
<li>Windows 平台发生 Crash 时，会生成 Dump 文件；</li>
<li><strong>航空领域</strong>的”黑匣子”则代表了最极致的日志系统，在飞行全程记录关键参数，并在紧急情况下保护这些宝贵数据。</li>
</ul>
<p>Chromium NetLog 是一个专为网络模块设计的结构化日志系统，其设计理念可以推广应用到其他场景，比如数据库操作或核心业务流程。我们可以将这种模式扩展到通用的结构化日志模块中。</p>
<h2 id="1-应用场景"><a href="#1-应用场景" class="headerlink" title="1. 应用场景"></a>1. 应用场景</h2><h3 id="数据库操作"><a href="#数据库操作" class="headerlink" title="数据库操作"></a>数据库操作</h3><p>我们的客户端采用基于 SQLite 封装的统一数据库存取模块，通过结构化日志记录对数据库操作的详细过程、耗时和异常信息，从而便于进行性能分析和问题排查。结构化日志不仅可以记录 SQL 指令、事务状态和耗时指标，还能捕获锁竞争、IO 异常和连接池状态等细节，为后续诊断提供精确依据。</p>
<h3 id="核心业务流程：登录与加会"><a href="#核心业务流程：登录与加会" class="headerlink" title="核心业务流程：登录与加会"></a>核心业务流程：登录与加会</h3><p>另一个例子是核心业务流程，如登录和加会。这两个流程往往涉及多个步骤，目前相关日志散落在庞大的日志文件中，甚至分布在不同的文件里。由于加会过程涉及多个模块，排查单个加会问题或分析性能时需要在多个文件间频繁切换、收集关键信息并进行时序关联，因此采用通用结构化日志方案在这些场景下显得尤为适用。</p>
<h2 id="2-需要解决的关键问题"><a href="#2-需要解决的关键问题" class="headerlink" title="2. 需要解决的关键问题"></a>2. 需要解决的关键问题</h2><h3 id="Debug-Log-的保留与淘汰"><a href="#Debug-Log-的保留与淘汰" class="headerlink" title="Debug Log 的保留与淘汰"></a><strong>Debug Log 的保留与淘汰</strong></h3><p>我们需要明确：原有的 Debug Log 是否还应继续保留，还是逐步淘汰？同时要设计出一个日志系统，既能满足日常开发调试需求，又能有效支持生产环境问题诊断。建议在开发阶段保留 Debug Log 以便快速定位问题，而在生产环境中则采用结构化日志记录关键业务和底层模块的信息，通过动态配置和日志级别控制，实现详略得当的日志策略。</p>
<h3 id="通用且可扩展的数据类型与接口设计"><a href="#通用且可扩展的数据类型与接口设计" class="headerlink" title="通用且可扩展的数据类型与接口设计"></a><strong>通用且可扩展的数据类型与接口设计</strong></h3><p>设计一套通用的数据类型和接口定义非常关键。每个日志事件应包含：</p>
<ul>
<li><strong>时间戳</strong>：记录事件发生的精确时刻；</li>
<li><strong>事件类型或步骤标识</strong>：如数据库操作类型、业务流程步骤、网络请求阶段等；</li>
<li><strong>附加参数</strong>：包括操作细节、耗时、错误码和异常信息等；</li>
<li><strong>关联 ID</strong>：例如 RequestId，用于关联同一操作的多个日志事件。</li>
</ul>
<p>这些日志数据可根据不同业务或使用场景序列化为 JSON、二进制或其它格式，并分别写入相应的 payload 文件，便于后续解析和分析。</p>
<h3 id="与现有日志系统的整合"><a href="#与现有日志系统的整合" class="headerlink" title="与现有日志系统的整合"></a><strong>与现有日志系统的整合</strong></h3><p>考虑到目前的日志系统已相当稳定，支持异步写入、加密等基础功能，新系统必须与现有系统兼容，充分利用现有优势。具体措施包括：</p>
<ul>
<li>提供兼容现有日志系统的接口，实现异步写入和加密传输；</li>
<li>渐进式集成，即在关键模块中先引入结构化日志记录，同时保留现有 Debug Log，待验证新系统稳定后再逐步推广；</li>
<li>通过配置统一管理日志级别、格式和存储路径，实现新旧日志系统的无缝衔接。</li>
</ul>
<h2 id="3-日志类型及-Troubleshooting-应用场景"><a href="#3-日志类型及-Troubleshooting-应用场景" class="headerlink" title="3. 日志类型及 Troubleshooting 应用场景"></a>3. 日志类型及 Troubleshooting 应用场景</h2><h3 id="Log-类型"><a href="#Log-类型" class="headerlink" title="Log 类型"></a><strong>Log 类型</strong></h3><ul>
<li><strong>Debug Log</strong>：以纯文本方式记录，便于阅读和快速定位问题。</li>
<li><strong>Event Log</strong>：采用结构化形式记录日志，便于解析与分析。具体包括：<ul>
<li><strong>网络相关</strong><ul>
<li><strong>WebSocket 全局连接状态</strong>：记录建立连接、重连、收发数据包统计及断开连接的各个事件和时间戳。</li>
<li><strong>未完成请求</strong>：记录仍在请求队列中、生命期未完成的请求信息，便于排查因野指针引起的问题。</li>
<li><strong>请求生命期</strong>：详细记录每个请求的连接状态变迁、结果、耗时等信息，涵盖各种错误码和 payload（如 DNS 解析失败、TCP 握手异常、TLS 证书验证结果、代理信息等）。</li>
<li><strong>性能统计</strong>：记录应用存活期间发送请求的总数、各阶段连接耗时统计、DNS 解析信息等数据。</li>
</ul>
</li>
<li><strong>数据库相关</strong><ul>
<li>记录SQL指令、事务状态、耗时指标</li>
<li>捕获锁竞争、IO异常、连接池状态</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="Troubleshooting-场景"><a href="#Troubleshooting-场景" class="headerlink" title="Troubleshooting 场景"></a><strong>Troubleshooting 场景</strong></h3><ul>
<li><strong>手动日志分析</strong><ul>
<li>在开发阶段用于问题排查。</li>
<li>针对线上产品中用户反馈问题时附带的日志进行分析。</li>
<li>对于关键事件（如加会失败、登录失败、Crash 等）自动收集相关日志。</li>
</ul>
</li>
<li><strong>诊断与统计功能</strong><ul>
<li>在应用运行期间，定期 dump 关键状态信息（如 CPU、内存、网络请求等）。</li>
<li>针对网络请求，记录所有发出的 HTTPS 请求，包括请求是否成功、每条请求的耗时分布以及 DNS、TCP、TLS 等各阶段的耗时统计。</li>
</ul>
</li>
<li><strong>自动化日志分析</strong><ul>
<li>目前主要通过正则表达式提取关键字，但若需要跨多条日志进行比对和关联分析，则通常需要多次扫描整个日志文件。</li>
</ul>
</li>
</ul>
<h2 id="4-具体实例与-NetLog-借鉴"><a href="#4-具体实例与-NetLog-借鉴" class="headerlink" title="4. 具体实例与 NetLog 借鉴"></a>4. 具体实例与 NetLog 借鉴</h2><p>假设用户在使用 Chromium 浏览器时，遇到某个网站加载异常慢。启用 NetLog 后，系统会记录下整个网络请求的事件序列，包括 DNS 解析、TCP 连接、TLS 握手、HTTP 请求和响应等阶段。通过 NetLog Viewer，我们可以直观地看到请求各阶段的时序图，如果发现 DNS 解析阶段耗时异常长，则很可能是这一环节出现了问题，从而指导开发者针对 DNS 环节进行进一步调查和优化。</p>
<p>此外，通过结合时序数据与各环节之间的关联关系，我们可以进一步探索自动化根因分析的可能性。比如，通过分析历史日志数据，当检测到 DNS 解析延迟超过正常阈值时，系统可自动判断可能存在 DNS 服务器异常或网络故障问题。这种数据驱动的方法将大大提高问题诊断的效率和准确性。</p>
<p><strong>回到我们的应用场景，如何关联一个请求生命周期的所有 LOG？</strong></p>
<p>在 Chromium 的 NetLog 设计中，所有与同一请求相关的日志都通过 <code>source id</code> 进行关联。而在 <code>zNet</code> 中，目前涉及到三个 ID：</p>
<ul>
<li><code>RequestId</code>：在创建 zNet 请求实例时生成，具有全局唯一性，适用于关联请求的生命周期及时序信息。</li>
<li><code>curl handle</code>：可能会被多个请求复用，无法唯一标识单个请求。</li>
<li><code>Web 返回的 trackingId</code>：仅在请求成功时可获取，不适用于完整的生命周期追踪。</li>
</ul>
<p><strong>现有问题</strong></p>
<p>当前的 <strong>troubleshooting</strong> 方式主要依赖 <strong>AfterEmitRequest</strong> 过滤所有请求，然后通过 <strong>RequestId</strong> 或 <strong>请求 URL</strong> 定位对应的请求状态日志，再结合 <strong>curl handle</strong> 追踪网络层日志（如连接状态、Request、Response 详情），最后再查找 <strong>Web 返回的 trackingId</strong> 进行进一步分析。这种方式逻辑机械、繁琐且冗余，增加了排查成本。</p>
<p><strong>NetLog 方案借鉴</strong></p>
<p>NetLog 通过 <strong>source id</strong> 关联 HTTP 请求的多个阶段（Phase），确保整个请求的所有事件都可以被统一追踪。</p>
<p>这里有个例子，NetLog 如何通过 source id 管理一个 HTTP 请求 Phase 的多个 events</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 开始 HTTP Stream Job Controller</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;params&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;url&quot;</span>: <span class="string">&quot;&lt;https://github.com/&gt;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;is_preconnect&quot;</span>: <span class="literal">true</span>,            <span class="comment">// 这是一个预连接请求</span></span><br><span class="line">    <span class="string">&quot;privacy_mode&quot;</span>: <span class="string">&quot;disabled&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;phase&quot;</span>: <span class="number">1</span>,                         <span class="comment">// BEGIN</span></span><br><span class="line">  <span class="string">&quot;source&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="number">21989</span>,                      <span class="comment">// source id</span></span><br><span class="line">    <span class="string">&quot;start_time&quot;</span>: <span class="string">&quot;223771674&quot;</span>,</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="number">30</span>                        <span class="comment">// HTTP_STREAM_JOB_CONTROLLER</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;time&quot;</span>: <span class="string">&quot;223771674&quot;</span>,</span><br><span class="line">  <span class="string">&quot;type&quot;</span>: <span class="number">177</span>                         <span class="comment">// HTTP_STREAM_JOB_CONTROLLER</span></span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 开始代理解析</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;phase&quot;</span>: <span class="number">1</span>,                         <span class="comment">// BEGIN</span></span><br><span class="line">  <span class="string">&quot;source&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="number">21989</span>,                      <span class="comment">// 复用了同一个 source id</span></span><br><span class="line">    <span class="string">&quot;start_time&quot;</span>: <span class="string">&quot;223771674&quot;</span>,</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="number">30</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;time&quot;</span>: <span class="string">&quot;223771674&quot;</span>,</span><br><span class="line">  <span class="string">&quot;type&quot;</span>: <span class="number">29</span>                          <span class="comment">// PROXY_RESOLUTION_SERVICE</span></span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 代理解析完成</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;phase&quot;</span>: <span class="number">2</span>,                         <span class="comment">// END</span></span><br><span class="line">  <span class="string">&quot;source&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="number">21989</span>,                      <span class="comment">// 仍然是同一个 source id</span></span><br><span class="line">    <span class="string">&quot;start_time&quot;</span>: <span class="string">&quot;223771674&quot;</span>,</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="number">30</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;time&quot;</span>: <span class="string">&quot;223771674&quot;</span>,</span><br><span class="line">  <span class="string">&quot;type&quot;</span>: <span class="number">29</span>                          <span class="comment">// 与开始事件类型相同</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果 zNet 也采用类似的方式，将 <strong>RequestId</strong> 作为主关联 ID，不仅能在请求生命周期内确保唯一性，还能减少日志筛选的复杂度，使问题分析更加直观高效。</p>
<p>因此，对于应用程序来说，借鉴 Chromium NetLog 的设计理念，我们可以构建一个多层次、结构化且统一格式的日志系统，有效解决现有日志中格式不统一、全局状态缺失、关键事件分散、自动化解析难度大和存储混乱等问题，从而为生产环境问题诊断、性能统计和系统优化提供坚实的数据支撑</p>
<h1 id="五、通用结构化事件日志模块-EventLogger"><a href="#五、通用结构化事件日志模块-EventLogger" class="headerlink" title="五、通用结构化事件日志模块 : EventLogger"></a>五、通用结构化事件日志模块 : EventLogger</h1><h2 id="1-事件类型"><a href="#1-事件类型" class="headerlink" title="1. 事件类型"></a>1. 事件类型</h2><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// event_types.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 网络事件类型</span></span><br><span class="line">enum <span class="keyword">class</span> <span class="title class_">NetworkEventType</span> &#123;</span><br><span class="line">    <span class="comment">// DNS 相关</span></span><br><span class="line">    <span class="variable constant_">DNS_RESOLUTION_START</span> = <span class="number">1000</span>,</span><br><span class="line">    <span class="variable constant_">DNS_TRANSACTION</span> = <span class="number">1001</span>,</span><br><span class="line">    <span class="variable constant_">DNS_CACHE_LOOKUP</span> = <span class="number">1002</span>,</span><br><span class="line">    <span class="variable constant_">DNS_CONFIG_CHANGED</span> = <span class="number">1003</span>,</span><br><span class="line">    <span class="variable constant_">DNS_RESOLUTION_END</span> = <span class="number">1004</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TCP 相关</span></span><br><span class="line">    <span class="variable constant_">TCP_CONNECT_START</span> = <span class="number">1100</span>,</span><br><span class="line">    <span class="variable constant_">TCP_CONNECT_ATTEMPT</span> = <span class="number">1101</span>,</span><br><span class="line">    <span class="variable constant_">TCP_CONNECT_END</span> = <span class="number">1102</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Socket 相关</span></span><br><span class="line">    <span class="variable constant_">SOCKET_ALIVE</span> = <span class="number">1200</span>,</span><br><span class="line">    <span class="variable constant_">SOCKET_OPEN</span> = <span class="number">1201</span>,</span><br><span class="line">    <span class="variable constant_">SOCKET_READ</span> = <span class="number">1202</span>,</span><br><span class="line">    <span class="variable constant_">SOCKET_WRITE</span> = <span class="number">1203</span>,</span><br><span class="line">    <span class="variable constant_">SOCKET_CLOSE</span> = <span class="number">1204</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// SSL/TLS 相关</span></span><br><span class="line">    <span class="variable constant_">SSL_CONNECT_START</span> = <span class="number">1300</span>,</span><br><span class="line">    <span class="variable constant_">SSL_HANDSHAKE</span> = <span class="number">1301</span>,</span><br><span class="line">    <span class="variable constant_">SSL_CERT_VERIFICATION</span> = <span class="number">1302</span>,</span><br><span class="line">    <span class="variable constant_">SSL_CONNECT_END</span> = <span class="number">1303</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// HTTP 相关</span></span><br><span class="line">    <span class="variable constant_">HTTP_TRANSACTION_START</span> = <span class="number">1400</span>,</span><br><span class="line">    <span class="variable constant_">HTTP_SEND_REQUEST_HEADERS</span> = <span class="number">1401</span>,</span><br><span class="line">    <span class="variable constant_">HTTP_SEND_REQUEST_BODY</span> = <span class="number">1402</span>,</span><br><span class="line">    <span class="variable constant_">HTTP_READ_RESPONSE_HEADERS</span> = <span class="number">1403</span>,</span><br><span class="line">    <span class="variable constant_">HTTP_READ_RESPONSE_BODY</span> = <span class="number">1404</span>,</span><br><span class="line">    <span class="variable constant_">HTTP_TRANSACTION_END</span> = <span class="number">1405</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// WebSocket 相关</span></span><br><span class="line">    <span class="variable constant_">WS_CONNECT_START</span> = <span class="number">1500</span>,</span><br><span class="line">    <span class="variable constant_">WS_HANDSHAKE</span> = <span class="number">1501</span>,</span><br><span class="line">    <span class="variable constant_">WS_FRAME_SENT</span> = <span class="number">1502</span>,</span><br><span class="line">    <span class="variable constant_">WS_FRAME_RECEIVED</span> = <span class="number">1503</span>,</span><br><span class="line">    <span class="variable constant_">WS_CONNECTION_CLOSED</span> = <span class="number">1504</span>,</span><br><span class="line">    <span class="variable constant_">WS_ERROR</span> = <span class="number">1505</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 网络事件</span></span><br><span class="line">    <span class="variable constant_">NETWORK_CHANGED</span> = <span class="number">1600</span>,</span><br><span class="line">    <span class="variable constant_">CONNECTION_POOL_CREATED</span> = <span class="number">1601</span>,</span><br><span class="line">    <span class="variable constant_">PROXY_CONFIG_CHANGED</span> = <span class="number">1602</span>,</span><br><span class="line">    <span class="variable constant_">NETWORK_QUALITY_CHANGED</span> = <span class="number">1603</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 数据库事件类型</span></span><br><span class="line">enum <span class="keyword">class</span> <span class="title class_">DatabaseEventType</span> &#123;</span><br><span class="line">    <span class="comment">// 连接管理</span></span><br><span class="line">    <span class="variable constant_">DB_OPEN</span> = <span class="number">2000</span>,</span><br><span class="line">    <span class="variable constant_">DB_CLOSE</span> = <span class="number">2001</span>,</span><br><span class="line">    <span class="variable constant_">DB_CONFIG</span> = <span class="number">2002</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 事务管理</span></span><br><span class="line">    <span class="variable constant_">TRANSACTION_BEGIN</span> = <span class="number">2100</span>,</span><br><span class="line">    <span class="variable constant_">TRANSACTION_COMMIT</span> = <span class="number">2101</span>,</span><br><span class="line">    <span class="variable constant_">TRANSACTION_ROLLBACK</span> = <span class="number">2102</span>,</span><br><span class="line">    <span class="variable constant_">TRANSACTION_SAVEPOINT</span> = <span class="number">2103</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询执行</span></span><br><span class="line">    <span class="variable constant_">QUERY_PREPARE</span> = <span class="number">2200</span>,</span><br><span class="line">    <span class="variable constant_">QUERY_EXECUTE</span> = <span class="number">2201</span>,</span><br><span class="line">    <span class="variable constant_">QUERY_RESET</span> = <span class="number">2202</span>,</span><br><span class="line">    <span class="variable constant_">QUERY_FINALIZE</span> = <span class="number">2203</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 语句类型</span></span><br><span class="line">    <span class="variable constant_">STMT_SELECT</span> = <span class="number">2300</span>,</span><br><span class="line">    <span class="variable constant_">STMT_INSERT</span> = <span class="number">2301</span>,</span><br><span class="line">    <span class="variable constant_">STMT_UPDATE</span> = <span class="number">2302</span>,</span><br><span class="line">    <span class="variable constant_">STMT_DELETE</span> = <span class="number">2303</span>,</span><br><span class="line">    <span class="variable constant_">STMT_CREATE</span> = <span class="number">2304</span>,</span><br><span class="line">    <span class="variable constant_">STMT_DROP</span> = <span class="number">2305</span>,</span><br><span class="line">    <span class="variable constant_">STMT_ALTER</span> = <span class="number">2306</span>,</span><br><span class="line">    <span class="variable constant_">STMT_PRAGMA</span> = <span class="number">2307</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 索引和优化</span></span><br><span class="line">    <span class="variable constant_">QUERY_PLAN</span> = <span class="number">2400</span>,</span><br><span class="line">    <span class="variable constant_">INDEX_USED</span> = <span class="number">2401</span>,</span><br><span class="line">    <span class="variable constant_">TABLE_LOCK</span> = <span class="number">2402</span>,</span><br><span class="line">    <span class="variable constant_">TABLE_SCAN</span> = <span class="number">2403</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 缓存管理</span></span><br><span class="line">    <span class="variable constant_">CACHE_HIT</span> = <span class="number">2500</span>,</span><br><span class="line">    <span class="variable constant_">CACHE_MISS</span> = <span class="number">2501</span>,</span><br><span class="line">    <span class="variable constant_">CACHE_FLUSH</span> = <span class="number">2502</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 错误处理</span></span><br><span class="line">    <span class="variable constant_">CONSTRAINT_VIOLATION</span> = <span class="number">2600</span>,</span><br><span class="line">    <span class="variable constant_">LOCKED_ERROR</span> = <span class="number">2601</span>,</span><br><span class="line">    <span class="variable constant_">IO_ERROR</span> = <span class="number">2602</span>,</span><br><span class="line">    <span class="variable constant_">CORRUPT_ERROR</span> = <span class="number">2603</span>,</span><br><span class="line">    <span class="variable constant_">SYNTAX_ERROR</span> = <span class="number">2604</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 事件相位</span></span><br><span class="line">enum <span class="keyword">class</span> <span class="title class_">EventPhase</span> &#123;</span><br><span class="line">    <span class="variable constant_">NONE</span> = <span class="number">0</span>,</span><br><span class="line">    <span class="variable constant_">BEGIN</span> = <span class="number">1</span>,</span><br><span class="line">    <span class="variable constant_">END</span> = <span class="number">2</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 日志源类型</span></span><br><span class="line">enum <span class="keyword">class</span> <span class="title class_">LogSourceType</span> &#123;</span><br><span class="line">    <span class="variable constant_">NONE</span> = <span class="number">0</span>,</span><br><span class="line">    <span class="variable constant_">NETWORK</span> = <span class="number">1</span>,</span><br><span class="line">    <span class="variable constant_">DATABASE</span> = <span class="number">2</span>,</span><br><span class="line">		<span class="comment">// ... 其他类型</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="2-数据结构"><a href="#2-数据结构" class="headerlink" title="2. 数据结构"></a>2. 数据结构</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// event_logger.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 事件源</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">EventSource</span> &#123;</span><br><span class="line">    <span class="type">uint32_t</span> id = <span class="number">0</span>;</span><br><span class="line">    LogSourceType type = LogSourceType::NONE;</span><br><span class="line">    std::string start_time;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">IsValid</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> id != <span class="number">0</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 事件条目</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> EventTypeEnum&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">EventEntry</span> &#123;</span><br><span class="line">    <span class="type">uint32_t</span> id = <span class="number">0</span>;</span><br><span class="line">    EventTypeEnum type;</span><br><span class="line">    EventPhase phase = EventPhase::NONE;</span><br><span class="line">    EventSource source;</span><br><span class="line">    std::string time;</span><br><span class="line">    nlohmann::json params;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 事件日志记录器</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> EventTypeEnum&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EventLogger</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">EventLogger</span><span class="params">(std::shared_ptr&lt;LegacyLogger&gt; legacy_logger)</span></span></span><br><span class="line"><span class="function">        : legacy_logger_(std::move(legacy_logger)) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建事件源</span></span><br><span class="line">    <span class="function">EventSource <span class="title">CreateSource</span><span class="params">(LogSourceType type)</span> </span>&#123;</span><br><span class="line">        EventSource source;</span><br><span class="line">        source.id = next_source_id_++;</span><br><span class="line">        source.type = type;</span><br><span class="line">        source.start_time = <span class="built_in">GetCurrentTimeStr</span>();</span><br><span class="line">        <span class="keyword">return</span> source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加事件</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">AddEvent</span><span class="params">(EventTypeEnum type,</span></span></span><br><span class="line"><span class="params"><span class="function">                 <span class="type">const</span> EventSource&amp; source,</span></span></span><br><span class="line"><span class="params"><span class="function">                 EventPhase phase,</span></span></span><br><span class="line"><span class="params"><span class="function">                 <span class="type">const</span> nlohmann::json&amp; params = &#123;&#125;)</span> </span>&#123;</span><br><span class="line">        EventEntry&lt;EventTypeEnum&gt; entry;</span><br><span class="line">        entry.id = next_event_id_++;</span><br><span class="line">        entry.type = type;</span><br><span class="line">        entry.phase = phase;</span><br><span class="line">        entry.source = source;</span><br><span class="line">        entry.time = <span class="built_in">GetCurrentTimeStr</span>();</span><br><span class="line">        entry.params = params;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 记录到传统日志系统</span></span><br><span class="line">        <span class="built_in">WriteToLegacyLog</span>(entry);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 存储事件</span></span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mutex_)</span></span>;</span><br><span class="line">        entries_.<span class="built_in">push_back</span>(entry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 导出为JSON</span></span><br><span class="line">    <span class="function">std::string <span class="title">ExportToJson</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mutex_)</span></span>;</span><br><span class="line"></span><br><span class="line">        nlohmann::json root;</span><br><span class="line">        nlohmann::json events = nlohmann::json::<span class="built_in">array</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; entry : entries_) &#123;</span><br><span class="line">            events.<span class="built_in">push_back</span>(&#123;</span><br><span class="line">                &#123;<span class="string">&quot;id&quot;</span>, entry.id&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;type&quot;</span>, <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(entry.type)&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;phase&quot;</span>, <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(entry.phase)&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;source&quot;</span>, &#123;</span><br><span class="line">                    &#123;<span class="string">&quot;id&quot;</span>, entry.source.id&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;type&quot;</span>, <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(entry.source.type)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;start_time&quot;</span>, entry.source.start_time&#125;</span><br><span class="line">                &#125;&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;time&quot;</span>, entry.time&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;params&quot;</span>, entry.params&#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        root[<span class="string">&quot;events&quot;</span>] = std::<span class="built_in">move</span>(events);</span><br><span class="line">        <span class="keyword">return</span> root.<span class="built_in">dump</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::shared_ptr&lt;LegacyLogger&gt; legacy_logger_;</span><br><span class="line">    std::atomic&lt;<span class="type">uint32_t</span>&gt; next_event_id_&#123;<span class="number">1</span>&#125;;</span><br><span class="line">    std::atomic&lt;<span class="type">uint32_t</span>&gt; next_source_id_&#123;<span class="number">1</span>&#125;;</span><br><span class="line">    <span class="keyword">mutable</span> std::mutex mutex_;</span><br><span class="line">    std::vector&lt;EventEntry&lt;EventTypeEnum&gt;&gt; entries_;</span><br><span class="line"></span><br><span class="line">    <span class="function">std::string <span class="title">GetCurrentTimeStr</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">auto</span> now = std::chrono::system_clock::<span class="built_in">now</span>();</span><br><span class="line">        <span class="keyword">auto</span> micros = std::chrono::<span class="built_in">duration_cast</span>&lt;std::chrono::microseconds&gt;(</span><br><span class="line">            now.<span class="built_in">time_since_epoch</span>()).<span class="built_in">count</span>();</span><br><span class="line">        <span class="keyword">return</span> std::<span class="built_in">to_string</span>(micros);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">WriteToLegacyLog</span><span class="params">(<span class="type">const</span> EventEntry&lt;EventTypeEnum&gt;&amp; entry)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (legacy_logger_) &#123;</span><br><span class="line">            std::string message = <span class="built_in">FormatLogMessage</span>(entry);</span><br><span class="line">            legacy_logger_-&gt;<span class="built_in">Log</span>(<span class="built_in">ConvertToLegacyLevel</span>(entry), message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">std::string <span class="title">FormatLogMessage</span><span class="params">(<span class="type">const</span> EventEntry&lt;EventTypeEnum&gt;&amp; entry)</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function">LegacyLogLevel <span class="title">ConvertToLegacyLevel</span><span class="params">(<span class="type">const</span> EventEntry&lt;EventTypeEnum&gt;&amp; entry)</span> <span class="type">const</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="3-用-HTTPRequestEntity-管理-Source"><a href="#3-用-HTTPRequestEntity-管理-Source" class="headerlink" title="3. 用 HTTPRequestEntity 管理 Source"></a>3. 用 HTTPRequestEntity 管理 Source</h2><p>在我们的网络库中，每个请求都被抽象为一个 <code>HTTPRequestEntity</code>，该对象全面 encapsulates（封装）请求的整个生命周期，涵盖从创建到完成的所有关键信息。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HTTPRequestEntity</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">HTTPRequestEntity</span>(<span class="type">const</span> std::string&amp; url, <span class="type">const</span> std::string&amp; method, NetworkLogger&amp; logger)</span><br><span class="line">        : <span class="built_in">url_</span>(url),</span><br><span class="line">          <span class="built_in">method_</span>(method),</span><br><span class="line">          <span class="built_in">logger_</span>(logger) &#123;</span><br><span class="line"></span><br><span class="line">        source_ = logger_.<span class="built_in">CreateSource</span>(LogSourceType::NETWORK);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">HTTPRequestEntity</span>() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取源，用于日志关联</span></span><br><span class="line">    <span class="function"><span class="type">const</span> EventSource&amp; <span class="title">GetSource</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> source_; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"></span><br><span class="line">    NetworkLogger&amp; logger_;</span><br><span class="line">    EventSource source_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="4-将-libCURL-日志转换为结构化事件日志"><a href="#4-将-libCURL-日志转换为结构化事件日志" class="headerlink" title="4. 将 libCURL 日志转换为结构化事件日志"></a>4. 将 libCURL 日志转换为结构化事件日志</h2><p>解析 CURL Debug Callback 输出，并将其转换为结构化的 Event Log，以便更好地分析和追踪请求过程。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CurlEventLogger</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">CurlEventLogger</span><span class="params">(NetworkLogger&amp; logger)</span></span></span><br><span class="line"><span class="function">        : logger_(logger) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 基于CURL调试信息记录网络事件</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">LogCurlDebugInfo</span><span class="params">(<span class="type">const</span> EventSource&amp; source, curl_infotype type,</span></span></span><br><span class="line"><span class="params"><span class="function">                         <span class="type">const</span> <span class="type">char</span>* data, <span class="type">size_t</span> size)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (data == <span class="literal">nullptr</span> || size == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">            <span class="keyword">case</span> CURLINFO_TEXT:</span><br><span class="line">                <span class="built_in">LogInfoEvent</span>(source, std::<span class="built_in">string</span>(data, size));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> CURLINFO_HEADER_OUT:</span><br><span class="line">                <span class="built_in">LogHeaderOut</span>(source, std::<span class="built_in">string</span>(data, size));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> CURLINFO_DATA_OUT:</span><br><span class="line">                <span class="built_in">LogDataOut</span>(source, size);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> CURLINFO_SSL_DATA_OUT:</span><br><span class="line">                <span class="built_in">LogSslDataOut</span>(source, size);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> CURLINFO_HEADER_IN:</span><br><span class="line">                <span class="built_in">LogHeaderIn</span>(source, std::<span class="built_in">string</span>(data, size));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> CURLINFO_DATA_IN:</span><br><span class="line">                <span class="built_in">LogDataIn</span>(source, size);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> CURLINFO_SSL_DATA_IN:</span><br><span class="line">                <span class="built_in">LogSslDataIn</span>(source, size);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    NetworkLogger&amp; logger_;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">LogInfoEvent</span><span class="params">(<span class="type">const</span> EventSource&amp; source, <span class="type">const</span> std::string&amp; info)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (info.<span class="built_in">find</span>(<span class="string">&quot;Trying &quot;</span>) != std::string::npos) &#123;</span><br><span class="line">            <span class="comment">// DNS解析已完成，开始连接</span></span><br><span class="line">            logger_.<span class="built_in">AddEvent</span>(</span><br><span class="line">                NetworkEventType::TCP_CONNECT_START,</span><br><span class="line">                source,</span><br><span class="line">                EventPhase::BEGIN,</span><br><span class="line">                &#123;&#123;<span class="string">&quot;info&quot;</span>, <span class="built_in">TrimString</span>(info)&#125;&#125;</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (info.<span class="built_in">find</span>(<span class="string">&quot;Connected to &quot;</span>) != std::string::npos) &#123;</span><br><span class="line">            <span class="comment">// TCP连接已建立</span></span><br><span class="line">            logger_.<span class="built_in">AddEvent</span>(</span><br><span class="line">                NetworkEventType::TCP_CONNECT_END,</span><br><span class="line">                source,</span><br><span class="line">                EventPhase::END,</span><br><span class="line">                &#123;</span><br><span class="line">                    &#123;<span class="string">&quot;info&quot;</span>, <span class="built_in">TrimString</span>(info)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;success&quot;</span>, <span class="literal">true</span>&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (info.<span class="built_in">find</span>(<span class="string">&quot;connect to &quot;</span>) != std::string::npos &amp;&amp; info.<span class="built_in">find</span>(<span class="string">&quot;failed:&quot;</span>) != std::string::npos) &#123;</span><br><span class="line">            <span class="comment">// TCP连接失败</span></span><br><span class="line">            logger_.<span class="built_in">AddEvent</span>(</span><br><span class="line">                NetworkEventType::TCP_CONNECT_END,</span><br><span class="line">                source,</span><br><span class="line">                EventPhase::END,</span><br><span class="line">                &#123;</span><br><span class="line">                    &#123;<span class="string">&quot;info&quot;</span>, <span class="built_in">TrimString</span>(info)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;success&quot;</span>, <span class="literal">false</span>&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (info.<span class="built_in">find</span>(<span class="string">&quot;SSL connection&quot;</span>) != std::string::npos) &#123;</span><br><span class="line">            <span class="keyword">if</span> (info.<span class="built_in">find</span>(<span class="string">&quot;SSL connection using &quot;</span>) != std::string::npos) &#123;</span><br><span class="line">                <span class="comment">// SSL握手开始</span></span><br><span class="line">                logger_.<span class="built_in">AddEvent</span>(</span><br><span class="line">                    NetworkEventType::SSL_CONNECT_START,</span><br><span class="line">                    source,</span><br><span class="line">                    EventPhase::BEGIN,</span><br><span class="line">                    &#123;&#123;<span class="string">&quot;info&quot;</span>, <span class="built_in">TrimString</span>(info)&#125;&#125;</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (info.<span class="built_in">find</span>(<span class="string">&quot; established&quot;</span>) != std::string::npos) &#123;</span><br><span class="line">                <span class="comment">// SSL连接建立</span></span><br><span class="line">                logger_.<span class="built_in">AddEvent</span>(</span><br><span class="line">                    NetworkEventType::SSL_CONNECT_END,</span><br><span class="line">                    source,</span><br><span class="line">                    EventPhase::END,</span><br><span class="line">                    &#123;</span><br><span class="line">                        &#123;<span class="string">&quot;info&quot;</span>, <span class="built_in">TrimString</span>(info)&#125;,</span><br><span class="line">                        &#123;<span class="string">&quot;success&quot;</span>, <span class="literal">true</span>&#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (info.<span class="built_in">find</span>(<span class="string">&quot;Hostname &quot;</span>) != std::string::npos) &#123;</span><br><span class="line">            <span class="keyword">if</span> (info.<span class="built_in">find</span>(<span class="string">&quot;was found in DNS cache&quot;</span>) != std::string::npos) &#123;</span><br><span class="line">                <span class="comment">// DNS缓存命中</span></span><br><span class="line">                logger_.<span class="built_in">AddEvent</span>(</span><br><span class="line">                    NetworkEventType::DNS_CACHE_LOOKUP,</span><br><span class="line">                    source,</span><br><span class="line">                    EventPhase::NONE,</span><br><span class="line">                    &#123;</span><br><span class="line">                        &#123;<span class="string">&quot;info&quot;</span>, <span class="built_in">TrimString</span>(info)&#125;,</span><br><span class="line">                        &#123;<span class="string">&quot;cache_hit&quot;</span>, <span class="literal">true</span>&#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (info.<span class="built_in">find</span>(<span class="string">&quot;Resolving &quot;</span>) != std::string::npos) &#123;</span><br><span class="line">                <span class="comment">// 开始DNS解析</span></span><br><span class="line">                logger_.<span class="built_in">AddEvent</span>(</span><br><span class="line">                    NetworkEventType::DNS_RESOLUTION_START,</span><br><span class="line">                    source,</span><br><span class="line">                    EventPhase::BEGIN,</span><br><span class="line">                    &#123;&#123;<span class="string">&quot;info&quot;</span>, <span class="built_in">TrimString</span>(info)&#125;&#125;</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (info.<span class="built_in">find</span>(<span class="string">&quot;Address &quot;</span>) != std::string::npos &amp;&amp; info.<span class="built_in">find</span>(<span class="string">&quot; resolved to &quot;</span>) != std::string::npos) &#123;</span><br><span class="line">            <span class="comment">// DNS解析完成</span></span><br><span class="line">            logger_.<span class="built_in">AddEvent</span>(</span><br><span class="line">                NetworkEventType::DNS_RESOLUTION_END,</span><br><span class="line">                source,</span><br><span class="line">                EventPhase::END,</span><br><span class="line">                &#123;</span><br><span class="line">                    &#123;<span class="string">&quot;info&quot;</span>, <span class="built_in">TrimString</span>(info)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;success&quot;</span>, <span class="literal">true</span>&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">LogHeaderOut</span><span class="params">(<span class="type">const</span> EventSource&amp; source, <span class="type">const</span> std::string&amp; headers)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">auto</span> parsed_headers = <span class="built_in">ParseHeaders</span>(headers);</span><br><span class="line">        std::string request_line;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 提取请求行</span></span><br><span class="line">        <span class="type">size_t</span> pos = headers.<span class="built_in">find</span>(<span class="string">&quot;\\r\\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (pos != std::string::npos) &#123;</span><br><span class="line">            request_line = headers.<span class="built_in">substr</span>(<span class="number">0</span>, pos);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        logger_.<span class="built_in">AddEvent</span>(</span><br><span class="line">            NetworkEventType::HTTP_SEND_REQUEST_HEADERS,</span><br><span class="line">            source,</span><br><span class="line">            EventPhase::NONE,</span><br><span class="line">            &#123;</span><br><span class="line">                &#123;<span class="string">&quot;headers&quot;</span>, parsed_headers&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;request_line&quot;</span>, request_line&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;raw_size&quot;</span>, headers.<span class="built_in">size</span>()&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">LogDataOut</span><span class="params">(<span class="type">const</span> EventSource&amp; source, <span class="type">size_t</span> size)</span> </span>&#123;</span><br><span class="line">        logger_.<span class="built_in">AddEvent</span>(</span><br><span class="line">            NetworkEventType::HTTP_SEND_REQUEST_BODY,</span><br><span class="line">            source,</span><br><span class="line">            EventPhase::NONE,</span><br><span class="line">            &#123;</span><br><span class="line">                &#123;<span class="string">&quot;size&quot;</span>, size&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">LogSslDataOut</span><span class="params">(<span class="type">const</span> EventSource&amp; source, <span class="type">size_t</span> size)</span> </span>&#123;</span><br><span class="line">        logger_.<span class="built_in">AddEvent</span>(</span><br><span class="line">            NetworkEventType::SSL_DATA_SENT,</span><br><span class="line">            source,</span><br><span class="line">            EventPhase::NONE,</span><br><span class="line">            &#123;</span><br><span class="line">                &#123;<span class="string">&quot;size&quot;</span>, size&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">LogHeaderIn</span><span class="params">(<span class="type">const</span> EventSource&amp; source, <span class="type">const</span> std::string&amp; headers)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">auto</span> parsed_headers = <span class="built_in">ParseHeaders</span>(headers);</span><br><span class="line">        <span class="type">long</span> status_code = <span class="built_in">ParseStatusCode</span>(headers);</span><br><span class="line">        std::string status_line;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 提取状态行</span></span><br><span class="line">        <span class="type">size_t</span> pos = headers.<span class="built_in">find</span>(<span class="string">&quot;\\r\\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (pos != std::string::npos) &#123;</span><br><span class="line">            status_line = headers.<span class="built_in">substr</span>(<span class="number">0</span>, pos);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        logger_.<span class="built_in">AddEvent</span>(</span><br><span class="line">            NetworkEventType::HTTP_READ_RESPONSE_HEADERS,</span><br><span class="line">            source,</span><br><span class="line">            EventPhase::NONE,</span><br><span class="line">            &#123;</span><br><span class="line">                &#123;<span class="string">&quot;headers&quot;</span>, parsed_headers&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;status_code&quot;</span>, status_code&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;status_line&quot;</span>, status_line&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;raw_size&quot;</span>, headers.<span class="built_in">size</span>()&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">LogDataIn</span><span class="params">(<span class="type">const</span> EventSource&amp; source, <span class="type">size_t</span> size)</span> </span>&#123;</span><br><span class="line">        logger_.<span class="built_in">AddEvent</span>(</span><br><span class="line">            NetworkEventType::HTTP_READ_RESPONSE_BODY,</span><br><span class="line">            source,</span><br><span class="line">            EventPhase::NONE,</span><br><span class="line">            &#123;</span><br><span class="line">                &#123;<span class="string">&quot;size&quot;</span>, size&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">LogSslDataIn</span><span class="params">(<span class="type">const</span> EventSource&amp; source, <span class="type">size_t</span> size)</span> </span>&#123;</span><br><span class="line">        logger_.<span class="built_in">AddEvent</span>(</span><br><span class="line">            NetworkEventType::SSL_DATA_RECEIVED,</span><br><span class="line">            source,</span><br><span class="line">            EventPhase::NONE,</span><br><span class="line">            &#123;</span><br><span class="line">                &#123;<span class="string">&quot;size&quot;</span>, size&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 工具函数</span></span><br><span class="line">    <span class="function">nlohmann::json <span class="title">ParseHeaders</span><span class="params">(<span class="type">const</span> std::string&amp; header_text)</span> </span>&#123;</span><br><span class="line">        nlohmann::json headers;</span><br><span class="line">        <span class="function">std::istringstream <span class="title">stream</span><span class="params">(header_text)</span></span>;</span><br><span class="line">        std::string line;</span><br><span class="line">        <span class="type">bool</span> first_line = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (std::<span class="built_in">getline</span>(stream, line)) &#123;</span><br><span class="line">            <span class="comment">// 跳过第一行（请求行或状态行）和空行</span></span><br><span class="line">            <span class="keyword">if</span> (first_line) &#123;</span><br><span class="line">                first_line = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 移除行尾的 \\r</span></span><br><span class="line">            <span class="keyword">if</span> (!line.<span class="built_in">empty</span>() &amp;&amp; line.<span class="built_in">back</span>() == <span class="string">&#x27;\\r&#x27;</span>) &#123;</span><br><span class="line">                line.<span class="built_in">pop_back</span>();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (line.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">size_t</span> pos = line.<span class="built_in">find</span>(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (pos != std::string::npos) &#123;</span><br><span class="line">                std::string key = line.<span class="built_in">substr</span>(<span class="number">0</span>, pos);</span><br><span class="line">                std::string value = line.<span class="built_in">substr</span>(pos + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 移除前后空格</span></span><br><span class="line">                key = <span class="built_in">TrimString</span>(key);</span><br><span class="line">                value = <span class="built_in">TrimString</span>(value);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!key.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">                    headers[key] = value;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> headers;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">long</span> <span class="title">ParseStatusCode</span><span class="params">(<span class="type">const</span> std::string&amp; header_line)</span> </span>&#123;</span><br><span class="line">        <span class="function">std::regex <span class="title">status_regex</span><span class="params">(<span class="string">&quot;HTTP/[0-9.]+ ([0-9]+)&quot;</span>)</span></span>;</span><br><span class="line">        std::smatch match;</span><br><span class="line">        <span class="keyword">if</span> (std::<span class="built_in">regex_search</span>(header_line, match, status_regex) &amp;&amp; match.<span class="built_in">size</span>() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> std::<span class="built_in">stol</span>(match[<span class="number">1</span>].<span class="built_in">str</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">std::string <span class="title">TrimString</span><span class="params">(<span class="type">const</span> std::string&amp; str)</span> </span>&#123;</span><br><span class="line">        <span class="type">size_t</span> start = str.<span class="built_in">find_first_not_of</span>(<span class="string">&quot; \\t\\r\\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (start == std::string::npos) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">size_t</span> end = str.<span class="built_in">find_last_not_of</span>(<span class="string">&quot; \\t\\r\\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> str.<span class="built_in">substr</span>(start, end - start + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>处理 CURL 请求的 Debug Callback</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SBCurlRequest</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">SBCurlRequest</span>(<span class="type">const</span> std::string&amp; url, <span class="type">const</span> std::string&amp; method)</span><br><span class="line">        : <span class="built_in">event_logger_</span>(logger_) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 初始化 curl</span></span><br><span class="line">        curl_ = <span class="built_in">curl_easy_init</span>();</span><br><span class="line"></span><br><span class="line">	      <span class="comment">// .....</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">SBCurlRequest</span>() &#123;</span><br><span class="line">        <span class="keyword">if</span> (curl_) &#123;</span><br><span class="line">            <span class="built_in">curl_easy_cleanup</span>(curl_);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    CURL* curl_ = <span class="literal">nullptr</span>;</span><br><span class="line">    NetworkLogger logger_;</span><br><span class="line">    CurlEventLogger event_logger_;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// CURL调试回调</span></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">DebugCallback</span><span class="params">(CURL* handle, curl_infotype type, <span class="type">char</span>* data, <span class="type">size_t</span> size, <span class="type">void</span>* userptr)</span> </span>&#123;</span><br><span class="line">        SBCurlRequest* request = <span class="built_in">static_cast</span>&lt;SBCurlRequest*&gt;(userptr);</span><br><span class="line">        <span class="keyword">if</span> (!request || !request-&gt;request_entity_) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将调试信息传递给事件日志记录器</span></span><br><span class="line">        request-&gt;event_logger_.<span class="built_in">LogCurlDebugInfo</span>(</span><br><span class="line">            request-&gt;request_entity_-&gt;<span class="built_in">GetSource</span>(),</span><br><span class="line">            type,</span><br><span class="line">            data,</span><br><span class="line">            size</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="5-结构化的网络事件-Log-示例"><a href="#5-结构化的网络事件-Log-示例" class="headerlink" title="5. 结构化的网络事件 Log 示例"></a>5. 结构化的网络事件 Log 示例</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;constants&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;logEventPhase&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;BEGIN&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;END&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;NONE&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;logEventTypes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;DNS_CACHE_LOOKUP&quot;</span><span class="punctuation">:</span> <span class="number">1002</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;DNS_CONFIG_CHANGED&quot;</span><span class="punctuation">:</span> <span class="number">1003</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;DNS_RESOLUTION_END&quot;</span><span class="punctuation">:</span> <span class="number">1004</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;DNS_RESOLUTION_START&quot;</span><span class="punctuation">:</span> <span class="number">1000</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;DNS_TRANSACTION&quot;</span><span class="punctuation">:</span> <span class="number">1001</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;HTTP_READ_RESPONSE_BODY&quot;</span><span class="punctuation">:</span> <span class="number">1404</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;HTTP_READ_RESPONSE_HEADERS&quot;</span><span class="punctuation">:</span> <span class="number">1403</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;HTTP_SEND_REQUEST_BODY&quot;</span><span class="punctuation">:</span> <span class="number">1402</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;HTTP_SEND_REQUEST_HEADERS&quot;</span><span class="punctuation">:</span> <span class="number">1401</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;HTTP_TRANSACTION_END&quot;</span><span class="punctuation">:</span> <span class="number">1405</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;HTTP_TRANSACTION_START&quot;</span><span class="punctuation">:</span> <span class="number">1400</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;NETWORK_ERROR&quot;</span><span class="punctuation">:</span> <span class="number">1900</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;SOCKET_ALIVE&quot;</span><span class="punctuation">:</span> <span class="number">1200</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;SOCKET_CLOSE&quot;</span><span class="punctuation">:</span> <span class="number">1204</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;SOCKET_OPEN&quot;</span><span class="punctuation">:</span> <span class="number">1201</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;SOCKET_READ&quot;</span><span class="punctuation">:</span> <span class="number">1202</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;SOCKET_WRITE&quot;</span><span class="punctuation">:</span> <span class="number">1203</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;SSL_CERT_VERIFICATION&quot;</span><span class="punctuation">:</span> <span class="number">1302</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;SSL_CONNECT_END&quot;</span><span class="punctuation">:</span> <span class="number">1303</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;SSL_CONNECT_START&quot;</span><span class="punctuation">:</span> <span class="number">1300</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;SSL_DATA_RECEIVED&quot;</span><span class="punctuation">:</span> <span class="number">1305</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;SSL_DATA_SENT&quot;</span><span class="punctuation">:</span> <span class="number">1304</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;SSL_HANDSHAKE&quot;</span><span class="punctuation">:</span> <span class="number">1301</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;TCP_CONNECT_ATTEMPT&quot;</span><span class="punctuation">:</span> <span class="number">1101</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;TCP_CONNECT_END&quot;</span><span class="punctuation">:</span> <span class="number">1102</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;TCP_CONNECT_START&quot;</span><span class="punctuation">:</span> <span class="number">1100</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;logSourceType&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;DATABASE&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;MEETING&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;NETWORK&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;NONE&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;events&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GET&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;request_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053600000000&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;https://api.github.com/users/octocat&gt;&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;phase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;start_time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053600000000&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053600000000&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1400</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;info&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Hostname api.github.com was found in DNS cache&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;phase&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;start_time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053600000000&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053600050000&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1002</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;info&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Trying 140.82.121.6:443...&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;phase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;start_time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053600000000&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053600100000&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1100</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;info&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Connected to api.github.com (140.82.121.6) port 443&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;success&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;phase&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;start_time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053600000000&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053600250000&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1102</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;info&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SSL connection using TLSv1.3 / TLS_AES_128_GCM_SHA256&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;phase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;start_time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053600000000&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053600300000&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1300</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">324</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;phase&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;start_time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053600000000&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053600350000&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1304</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">512</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;phase&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;start_time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053600000000&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053600400000&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1305</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;info&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SSL connection established, cipher: TLS_AES_128_GCM_SHA256&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;success&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;phase&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;start_time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053600000000&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053600500000&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1303</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">9</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;Accept&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/json&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;Host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;api.github.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;User-Agent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;EventLogger/1.0&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;raw_size&quot;</span><span class="punctuation">:</span> <span class="number">127</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;request_line&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GET /users/octocat HTTP/1.1&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;phase&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;start_time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053600000000&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053600550000&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1401</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;Content-Type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/json; charset=utf-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;Date&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Wed, 16 Feb 2024 10:00:01 GMT&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ETag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;W/\\&quot;</span><span class="number">12345</span>abcdef\\<span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;Server&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GitHub.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;Status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;200 OK&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;X-RateLimit-Limit&quot;</span><span class="punctuation">:</span> <span class="string">&quot;60&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;X-RateLimit-Remaining&quot;</span><span class="punctuation">:</span> <span class="string">&quot;59&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;raw_size&quot;</span><span class="punctuation">:</span> <span class="number">532</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;status_code&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;status_line&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HTTP/1.1 200 OK&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;phase&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;start_time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053600000000&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053600750000&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1403</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">1024</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;phase&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;start_time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053600000000&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053600800000&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1404</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">1256</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;phase&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;start_time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053600000000&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053600850000&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1404</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">13</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;size_download&quot;</span><span class="punctuation">:</span> <span class="number">2280</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;status_code&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;success&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total_time_ms&quot;</span><span class="punctuation">:</span> <span class="number">875</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;phase&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;start_time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053600000000&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053600875000&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1405</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">14</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GET&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;request_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053601000000&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;https://nonexistent.example.com/api&gt;&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;phase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;start_time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053601000000&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053601000000&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1400</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">15</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;info&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Resolving nonexistent.example.com...&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;phase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;start_time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053601000000&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053601050000&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1000</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">16</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;info&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Host nonexistent.example.com not found: 3(NXDOMAIN)&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;success&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;phase&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;start_time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053601000000&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053607050000&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1004</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">17</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;curl_code&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;error_message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Couldn&#x27;t resolve host name&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;phase&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;start_time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053601000000&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053607055000&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1405</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">18</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;curl_code&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;error_message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Couldn&#x27;t resolve host name&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;https://nonexistent.example.com/api&gt;&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;phase&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;start_time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053601000000&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1708053607056000&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1900</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="6-应用场景"><a href="#6-应用场景" class="headerlink" title="6. 应用场景"></a>6. 应用场景</h2><ul>
<li>代替 MEMLOG，用于线上问题 Troubleshooting</li>
<li>诊断窗口可以导入分析，产生可视化报表</li>
<li><p>自动化分析、用户 AI 训练</p>
<p>  其实并不需要额外的训练。大语言模型本身已经具备出色的分析能力。我将上述 Log 示例作为输入，让大模型进行解析，得到的输出结果如下，可以看出其表现已经相当优秀。</p>
<p>  <strong>Claude 的分析输出结果：</strong></p>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">第一个请求 (request_id<span class="punctuation">:</span> <span class="string">&quot;1&quot;</span>)<span class="punctuation">:</span></span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> 时间<span class="punctuation">:</span> 从 <span class="number">1708053600000000</span> 开始 (约<span class="number">2024</span>年<span class="number">2</span>月<span class="number">16</span>日<span class="number">10</span><span class="punctuation">:</span><span class="number">00</span><span class="punctuation">:</span><span class="number">00</span>)</span><br><span class="line"><span class="number">2.</span> 目标<span class="punctuation">:</span> GET https<span class="punctuation">:</span><span class="comment">//api.github.com/users/octocat</span></span><br><span class="line"><span class="number">3.</span> 请求过程<span class="punctuation">:</span></span><br><span class="line">    - DNS查询<span class="punctuation">:</span> 发现 <span class="punctuation">[</span>api.github.com<span class="punctuation">]</span>(https<span class="punctuation">:</span><span class="comment">//api.github.com/) 在DNS缓存中</span></span><br><span class="line">    - TCP连接<span class="punctuation">:</span> 连接到 <span class="number">140.82</span><span class="number">.121</span><span class="number">.6</span><span class="punctuation">:</span><span class="number">443</span> 端口，连接成功</span><br><span class="line">    - SSL/TLS握手<span class="punctuation">:</span> 使用 TLSv1<span class="number">.3</span> 和 TLS_AES_128_GCM_SHA256 加密套件</span><br><span class="line">    - HTTP请求<span class="punctuation">:</span> 发送带有基本headers的GET请求</span><br><span class="line">    - 服务器响应<span class="punctuation">:</span></span><br><span class="line">        - 状态码<span class="punctuation">:</span> <span class="number">200</span> OK</span><br><span class="line">        - 收到总计<span class="number">2280</span>字节的响应数据</span><br><span class="line">        - 完整请求耗时<span class="punctuation">:</span> <span class="number">875</span>毫秒</span><br><span class="line">    - 整个请求成功完成</span><br><span class="line"></span><br><span class="line">第二个请求 (request_id<span class="punctuation">:</span> <span class="string">&quot;2&quot;</span>)<span class="punctuation">:</span></span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> 时间<span class="punctuation">:</span> 从 <span class="number">1708053601000000</span> 开始 (比第一个请求晚<span class="number">1</span>秒)</span><br><span class="line"><span class="number">2.</span> 目标<span class="punctuation">:</span> GET https<span class="punctuation">:</span><span class="comment">//nonexistent.example.com/api</span></span><br><span class="line"><span class="number">3.</span> 请求过程<span class="punctuation">:</span></span><br><span class="line">    - DNS解析<span class="punctuation">:</span> 尝试解析 <span class="punctuation">[</span>nonexistent.example.com<span class="punctuation">]</span>(https<span class="punctuation">:</span><span class="comment">//nonexistent.example.com/)</span></span><br><span class="line">    - 失败<span class="punctuation">:</span> 收到 NXDOMAIN 错误(域名不存在)</span><br><span class="line">    - 请求终止<span class="punctuation">:</span></span><br><span class="line">        - 错误代码<span class="punctuation">:</span> <span class="number">6</span></span><br><span class="line">        - 错误信息<span class="punctuation">:</span> <span class="string">&quot;Couldn&#x27;t resolve host name&quot;</span></span><br><span class="line">    - 整个请求失败，耗时约<span class="number">6</span>秒</span><br><span class="line"></span><br><span class="line">这个日志系统使用了不同的事件类型来追踪请求的各个阶段：</span><br><span class="line"></span><br><span class="line">- <span class="number">1000</span>系列<span class="punctuation">:</span> DNS相关事件</span><br><span class="line">- <span class="number">1100</span>系列<span class="punctuation">:</span> TCP连接事件</span><br><span class="line">- <span class="number">1300</span>系列<span class="punctuation">:</span> SSL/TLS事件</span><br><span class="line">- <span class="number">1400</span>系列<span class="punctuation">:</span> HTTP事件</span><br><span class="line">- <span class="number">1900</span>系列<span class="punctuation">:</span> 错误事件</span><br><span class="line"></span><br><span class="line">每个事件都包含了详细的时间戳、事件类型、阶段(开始/结束/中间)以及相关参数，这对于调试网络问题和性能分析非常有帮助。</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h1><p>通过分析当前日志系统的问题并结合 Chromium NetLog 的设计经验，我们可以得出以下几点启示：</p>
<ol>
<li>日志系统应该采用统一的格式和标准，便于工具化处理和自动化分析</li>
<li>需要建立完整的上下文跟踪机制，特别是在处理复杂的异步操作时</li>
<li>应该支持多级别、多类型的日志记录，以适应不同的调试场景</li>
<li>日志的存储和检索机制需要优化，支持高效的过滤和关联分析</li>
<li>要在详细程度和性能开销之间找到平衡点：既能满足日常开发调试需求，又能有效支持生产环境问题诊断的日志系统</li>
</ol>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Chromium/" rel="tag"><i class="fa fa-tag"></i> Chromium</a>
              <a href="/tags/Troubleshooting/" rel="tag"><i class="fa fa-tag"></i> Troubleshooting</a>
              <a href="/tags/%E5%85%B3%E8%81%94%E5%88%86%E6%9E%90/" rel="tag"><i class="fa fa-tag"></i> 关联分析</a>
              <a href="/tags/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%88%86%E6%9E%90/" rel="tag"><i class="fa fa-tag"></i> 自动化分析</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/02/20/future/" rel="prev" title="这短短几十年，我们仿佛穿越了好几个时代">
                  <i class="fa fa-angle-left"></i> 这短短几十年，我们仿佛穿越了好几个时代
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/03/02/flomo/" rel="next" title="记录、Review、联结：我的 flomo 笔记使用心得">
                  记录、Review、联结：我的 flomo 笔记使用心得 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">祁迪</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  




<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"ustcqidi/blog-comments","issue_term":"pathname","theme":"github-light","cdn":"https://utteranc.es/client.js"}</script>
<script src="/js/third-party/comments/utterances.js"></script>

</body>
</html>
